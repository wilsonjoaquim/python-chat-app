<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Batepapo (Python)</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js" integrity="sha512-8BHxHDLsOHx+flIrQ0DrZcea7MkHqRU5GbTHmbdzMRnAaoCIkZ97PqZcXJkKZckMMhqfoeaJE+DNUVuyoQsO3Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    
    <div class="username-container">
        <h1>Batepapo App</h1>
        <span id="current-username"></span>
        <input type="text" id="username-input" placeholder="Novo usuÃ¡rio" />
        <button id="update-username-button">Atualizar Nome de Utilizador</button>
    </div>
    <div class="chat-messages" id="chat-messages">
    </div>
    <div class="chat-input">
        <input type="text" id="message-input" placeholder="Digite a sua mensagem aqui..."/>
        <button id="send-button">Enviar</button>

    </div>
    <script>
        const socket = io();
        const chatMessages = document.getElementById("chat-messages");
        const messageInput = document.getElementById("message-input");
        const sendButton = document.getElementById("send-button");
        const currentUsernameSpan = document.getElementById("username-input");
        const usernameInput = document.getElementById("username-input");
        const updateUsernameButton = document.getElementById("update-username-button");
        let currentUsername = "";

        socket.on("set_username", (data) => {
            currentUsername = data.username 
            currentUsernameSpan.textContent = `Seu nome de utilizador: ${currentUsername}`
        })

        socket.on("user_joined", data => {
            addMessage(`${data.username} juntou-se ao chat`,"system")
        })

        socket.on("user_left", data => {
            addMessage(`${data.username} saiu ao chat`,"system")
        })

        socket.on("new_message", (data) => {
            addMessage(data.message, "user", data.username, data.avatar)
        })

        socket.on("username_updated", (data) => {
            addMessage(`${data.old_username} mudou o nome para ${data.new_username}`,"system")

            if(data.old_username == currentUsername){
                currentUsername = data.new_username;
                currentUsernameSpan.textContent = `Seu nome de utilizador: ${currentUsername}`;
            }
        })

        sendButton.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", (e) => {
            if(e.key === "Enter") sendMessage()
        })
        
        updateUsernameButton.addEventListener("click", updateUsername)
        function sendMessage(){
            const message = messageInput.value.trim();
            if(message) {
                socket.emit("send_message", {message});
                messageInput.value = "";
            }
        }

        function updateUsername(){
            const newUsername = usernameInput.value.trim();
            if(newUsername && newUsername !== currentUsername){
                socket.emit("update_username", {username:newUsername});
                usernameInput.value = "";
            }
        }

        function addMessage(message, type, username="", avatar=""){
                const messageElement = document.createElement("div");
                messageElement.className = "message";

                if(type === "user"){
                    const isSentMessage = username === currentUsername;
                    if (isSentMessage){
                        messageElement.classList.add("sent");
                    }
                    const avatarImg = document.createElement("img");
                    avatarImg.src = avatar;
                    messageElement.appendChild(avatarImg);

                    const contentDiv = document.createElement("div");
                    contentDiv.className = "message-content";

                    const usernameDiv  = document.createElement("div");
                    usernameDiv.className = "message-username";
                    usernameDiv.textContent = username;
                    contentDiv.appendChild(usernameDiv);

                    const messageText = document.createElement("div");
                    messageText.textContent = message;
                    contentDiv.appendChild(messageText);

                    messageElement.appendChild(contentDiv);

                } else {
                    messageElement.className = "system-message";
                    messageElement.textContent = message;
                }
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
    </script>
</body>
</html>